#cloud-config
hostname: mock-infoblox
fqdn: mock-infoblox.lab.local

# System configuration
system_info:
  default_user:
    name: ubuntu
    plain_text_passwd: ubuntu123!
    lock_passwd: false
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash

users:
  - name: ubuntu
    plain_text_passwd: ubuntu123!
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    lock_passwd: false
    home: /home/ubuntu
    ssh_authorized_keys:
      - ${ssh_public_key}

ssh_pwauth: true

chpasswd:
  expire: false
  users:
    - name: ubuntu
      password: ubuntu123!
      type: text

# Network configuration
write_files:
  - path: /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg
    content: |
      network: {config: disabled}
    permissions: '0644'
  - path: /etc/netplan/99-netcfg.yaml
    content: |
      network:
        version: 2
        ethernets:
          eth0:
            dhcp4: false
            addresses:
              - ${ip_address}/${subnet_bits}
            routes:
              - to: default
                via: ${gateway}
            nameservers:
              addresses:
                - 8.8.8.8
                - 8.8.4.4
    permissions: '0644'
  - path: /opt/mock-infoblox/app.py
    permissions: '0755'
    content: |
      ${app_content}
  - path: /etc/systemd/system/mock-infoblox.service
    permissions: '0644'
    content: |
      [Unit]
      Description=Mock Infoblox WAPI Server
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=simple
      User=root
      WorkingDirectory=/opt/mock-infoblox
      Environment="PATH=/usr/local/bin:/usr/bin:/bin"
      ExecStart=/usr/bin/python3 /opt/mock-infoblox/app.py
      Restart=always
      RestartSec=10

      [Install]
      WantedBy=multi-user.target

# Packages to install
packages:
  - python3
  - python3-pip
  - python3-venv

runcmd:
  # Apply netplan config
  - netplan apply
  
  # Set password
  - echo 'ubuntu:ubuntu123!' | chpasswd
  - usermod -aG sudo ubuntu
  
  # Enable SSH password auth
  - sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
  - systemctl enable ssh
  - systemctl restart ssh
  
  # Install Flask and pyOpenSSL
  - pip3 install --break-system-packages Flask pyOpenSSL
  
  # Start the mock Infoblox service
  - systemctl daemon-reload
  - systemctl enable mock-infoblox
  - systemctl start mock-infoblox
  
  # Final message
  - echo "***MOCK-INFOBLOX*** Ready at ${ip_address}:443. Login ubuntu/ubuntu123!"

final_message: "Mock Infoblox WAPI server is ready!"
